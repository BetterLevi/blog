<!DOCTYPE html>
<html lang="zh-cmn-Hans">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Why So Serious?</title>
  
    <link rel="icon" href="/blog/assets/smile.JPG">
  
  
  
  <!--link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css"-->
  
<link rel="stylesheet" href="//cdn.jsdelivr.net/highlight.js/9.10.0/styles/github-gist.min.css">

  
<link rel="stylesheet" href="/blog/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

<body>
<div class="Shell">
    <aside class='SideBar'>
    <section class='avatar' style="background-image: url(/blog/assets/header.png)">
        <div class='av-pic' style="background-image: url(/blog/assets/avatar.jpg)">
        </div>
    </section>
    <section class='menu'>
        <div>Why So Serious?</div>
        
        <ul>
          
            <a href="/blog/" class="Btn">
              <li>Home</li>
            </a>  
          
            <a href="/blog/categories/" class="Btn">
              <li>Categories</li>
            </a>  
          
            <a href="/blog/about/" class="Btn">
              <li>About</li>
            </a>  
          
        </ul>
    </section>
    <section class="media">
        
    </section>
</aside>

    <div class="container">
        <div data-pager-shell>
            <ul class="Index">
  
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/blog/2021/03/05/Eureka%E9%99%90%E6%B5%81%E5%99%A8RateLimiter%E6%BA%90%E7%A0%81/">Eureka限流器RateLimiter源码</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2021-03-05T06:30:07.000Z" itemprop="datePublished">
    2021-03-05
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/blog/categories/SpringCloud/">SpringCloud</a> }
  </li>

  <li class="meta-text">
  { <a href="/blog/categories/SpringCloud/Eureka/">Eureka</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <a id="more"></a>

<h3 id="Eureka限流器RateLimiter源码"><a href="#Eureka限流器RateLimiter源码" class="headerlink" title="Eureka限流器RateLimiter源码"></a>Eureka限流器RateLimiter源码</h3><p>Eureka中ReteLimiter基于令牌桶算法实现。令牌桶算法的实现原理是系统以一个恒定的速率往桶中放入令牌，请求进来时先从通知获取一个令牌，若此时桶中无令牌可用则拒绝服务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> SourceCode;<br><br><span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicInteger;<br><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 该类中有两个关键参数：</span><br><span class="hljs-comment"> *     burst size - 系统在峰值时允许访问的最大请求量</span><br><span class="hljs-comment"> *     average rate - 每秒/分钟的请求个数</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RateLimiter</span> </span>&#123;<br><br>    <span class="hljs-comment">//分钟和秒与毫秒之间的转换率</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> rateToMsConversion;<br><br>    <span class="hljs-comment">//已经被消费的令牌个数</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicInteger consumedTokens = <span class="hljs-keyword">new</span> AtomicInteger();<br><br>    <span class="hljs-comment">//最后一次填充令牌桶的时间戳</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicLong lastRefillTime = <span class="hljs-keyword">new</span> AtomicLong(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-meta">@Deprecated</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RateLimiter</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>(TimeUnit.SECONDS);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">RateLimiter</span><span class="hljs-params">(TimeUnit averageRateUnit)</span> </span>&#123;<br>        <span class="hljs-keyword">switch</span> (averageRateUnit) &#123;<br>            <span class="hljs-keyword">case</span> SECONDS:<br>                <span class="hljs-comment">//限流器单位为秒，则转换率为1000</span><br>                rateToMsConversion = <span class="hljs-number">1000</span>;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> MINUTES:<br>                <span class="hljs-comment">//限流器单位为分钟，则转换率为60*1000</span><br>                rateToMsConversion = <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>;<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">default</span>:<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalArgumentException(<span class="hljs-string">&quot;TimeUnit of &quot;</span> + averageRateUnit + <span class="hljs-string">&quot; is not supported&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">acquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> burstSize, <span class="hljs-keyword">long</span> averageRate)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> acquire(burstSize, averageRate, System.currentTimeMillis());<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">acquire</span><span class="hljs-params">(<span class="hljs-keyword">int</span> burstSize, <span class="hljs-keyword">long</span> averageRate, <span class="hljs-keyword">long</span> currentTimeMillis)</span> </span>&#123;<br>        <span class="hljs-comment">//当限流器获取令牌的最大值或速率小于等于0时，认为不进行限速</span><br>        <span class="hljs-keyword">if</span> (burstSize &lt;= <span class="hljs-number">0</span> || averageRate &lt;= <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// Instead of throwing exception, we just let all the traffic go</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-comment">//重新填充令牌</span><br>        refillToken(burstSize, averageRate, currentTimeMillis);<br>        <span class="hljs-keyword">return</span> consumeToken(burstSize);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refillToken</span><span class="hljs-params">(<span class="hljs-keyword">int</span> burstSize, <span class="hljs-keyword">long</span> averageRate, <span class="hljs-keyword">long</span> currentTimeMillis)</span> </span>&#123;<br>        <span class="hljs-comment">//上次填充令牌桶的时间戳</span><br>        <span class="hljs-keyword">long</span> refillTime = lastRefillTime.get();<br>        <span class="hljs-comment">//上次填充距离现在的时间段</span><br>        <span class="hljs-keyword">long</span> timeDelta = currentTimeMillis - refillTime;<br>        <span class="hljs-comment">//该时间段内需要填充的新的令牌个数（averageRate是恒定的令牌填充速率）</span><br>        <span class="hljs-keyword">long</span> newTokens = timeDelta * averageRate / rateToMsConversion;<br>        <span class="hljs-comment">//如果需要填充新令牌</span><br>        <span class="hljs-keyword">if</span> (newTokens &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//计算新的填充令牌的时间点</span><br>            <span class="hljs-keyword">long</span> newRefillTime = refillTime == <span class="hljs-number">0</span> <span class="hljs-comment">//初次填充</span><br>                    ? currentTimeMillis<br>                    <span class="hljs-comment">//计算当前时间，不直接使用currentTimeMills是防止不足以填充一个令牌的时长被吞</span><br>                    : refillTime + newTokens * rateToMsConversion / averageRate;<br>            <span class="hljs-comment">//利用CAS机制保证只有一个线程可以将lastRefillTime更新成功</span><br>            <span class="hljs-keyword">if</span> (lastRefillTime.compareAndSet(refillTime, newRefillTime)) &#123;<br>                <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>                    <span class="hljs-comment">//当前已经消费的令牌个数</span><br>                    <span class="hljs-keyword">int</span> currentLevel = consumedTokens.get();<br>                    <span class="hljs-comment">//计算新的填充令牌后的已消耗的令牌数量， 如果此时 `burstSize` 更小，以它作为已消耗的令牌数量。</span><br>                    <span class="hljs-keyword">int</span> adjustedLevel = Math.min(currentLevel, burstSize); <span class="hljs-comment">// In case burstSize decreased</span><br>                    <span class="hljs-comment">//令牌桶中剩余的令牌数量，最小为0</span><br>                    <span class="hljs-keyword">int</span> newLevel = (<span class="hljs-keyword">int</span>) Math.max(<span class="hljs-number">0</span>, adjustedLevel - newTokens);<br>                    <span class="hljs-comment">//通过 CAS 保证避免覆盖设置正在消费令牌的线程</span><br>                    <span class="hljs-keyword">if</span> (consumedTokens.compareAndSet(currentLevel, newLevel)) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">consumeToken</span><span class="hljs-params">(<span class="hljs-keyword">int</span> burstSize)</span> </span>&#123;<br>        <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>            <span class="hljs-keyword">int</span> currentLevel = consumedTokens.get();<br>            <span class="hljs-comment">//没有令牌</span><br>            <span class="hljs-keyword">if</span> (currentLevel &gt;= burstSize) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>            &#125;<br>            <span class="hljs-comment">//通过 CAS 避免和正在消费令牌或者填充令牌的线程冲突</span><br>            <span class="hljs-keyword">if</span> (consumedTokens.compareAndSet(currentLevel, currentLevel + <span class="hljs-number">1</span>)) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">reset</span><span class="hljs-params">()</span> </span>&#123;<br>        consumedTokens.set(<span class="hljs-number">0</span>);<br>        lastRefillTime.set(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/blog/2021/03/03/How%20dose%20@EnableEurekaServer%20work%20in%20Spring%20Cloud?/">Spring Cloud中@EnableEurekaServer如何启动Eureka Server</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2021-03-03T10:01:51.000Z" itemprop="datePublished">
    2021-03-03
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/blog/categories/SpringCloud/">SpringCloud</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <a id="more"></a>

<h3 id="How-dose-EnableEurekaServer-work-in-Spring-Cloud"><a href="#How-dose-EnableEurekaServer-work-in-Spring-Cloud" class="headerlink" title="How dose @EnableEurekaServer work in Spring Cloud?"></a>How dose @EnableEurekaServer work in Spring Cloud?</h3><p>We often use an annotation called @EnableEurekaServer to start the Eureka Server in Spring Cloud, but how dose it work? I will explain the process by reading the source code in this blog.</p>
<h4 id="1-Auto-initialization-and-configuration"><a href="#1-Auto-initialization-and-configuration" class="headerlink" title="1. Auto initialization and configuration"></a>1. Auto initialization and configuration</h4><p><strong>@EnableEurekaServer</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Annotation to activate Eureka Server related configuration.</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> EurekaServerAutoConfiguration&#125;</span><br><span class="hljs-comment"> * </span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Dave Syer</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Biju Kunjummen</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-meta">@Target(ElementType.TYPE)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-meta">@Import(EurekaServerMarkerConfiguration.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> EnableEurekaServer &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>This annotation does nothing but import a class named <em>EurekaServerMarkerConfiguration</em>, so let’s look at the implementation of this class.</p>
<p><strong>EurekaServerMarkerConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Responsible for adding in a marker bean to activate</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> EurekaServerAutoConfiguration&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Biju Kunjummen</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaServerMarkerConfiguration</span> </span>&#123;<br><br>	<span class="hljs-meta">@Bean</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> Marker <span class="hljs-title">eurekaServerMarkerBean</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Marker();<br>	&#125;<br><br>	<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Marker</span> </span>&#123;<br><br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>As we can see, this class init a Bean named Marker and Marker is just an empty class, so it‘s used to make some mark. In other words, there are some operations will be executed once Marker exists.</p>
<h4 id="2-Eureka-Server"><a href="#2-Eureka-Server" class="headerlink" title="2. Eureka Server"></a>2. Eureka Server</h4><p>By reading source code and comments, we can find that there is class named EurekaServerAutoConfiguration depends on the Marker to config the Eureka Server.</p>
<p><strong>2.1 EurekaServerAutoConfiguration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@Import(EurekaServerInitializerConfiguration.class)</span><br><span class="hljs-meta">@ConditionalOnBean(EurekaServerMarkerConfiguration.Marker.class)</span><br><span class="hljs-meta">@EnableConfigurationProperties(&#123; EurekaDashboardProperties.class,</span><br><span class="hljs-meta">		InstanceRegistryProperties.class &#125;)</span><br><span class="hljs-meta">@PropertySource(&quot;classpath:/eureka/server.properties&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaServerAutoConfiguration</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">WebMvcConfigurerAdapter</span> </span>&#123;<br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>
<p>This is a configuration class, and there are several annotations:</p>
<ol>
<li><em>@Import</em> imports a <em>EurekaServerInitializerConfiguration.class</em>, and this class is responsible for the initialization of Eureka Server.</li>
<li><em>@ConditionalOnBean</em> means only if Bean of <em>EurekaServerMarkerConfiguration.Marker.class</em> exists, the current class will be injected to Spring container as a new Bean.</li>
<li><em>@EnableConfigurationProperties</em> makes <em>EurekaDashboardProperties.class</em> and <em>InstanceRegistryProperties.class</em> effective.<br><em>EurekaDashboardProperties.class</em> mainly config for UI like path to the Eureka Dashboard and <em>InstanceRegistryProperties.class</em> mainly config for instance register like prefix for Eureka instance.</li>
<li><em>@PropertySource</em> is used to specify the path of config file</li>
</ol>
<p>From the code we can know the Eureka Server is inited by <em>EurekaServerInitializerConfiguration.class,</em> so let’s look the source code this class.</p>
<p><strong>2.2 EurekaServerInitializerConfiguration源码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaServerInitializerConfiguration</span></span><br><span class="hljs-class">		<span class="hljs-keyword">implements</span> <span class="hljs-title">ServletContextAware</span>, <span class="hljs-title">SmartLifecycle</span>, <span class="hljs-title">Ordered</span> </span>&#123;<br>  ...<br>    <span class="hljs-meta">@Override</span><br>	<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">()</span> </span>&#123;<br>		<span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">new</span> Runnable() &#123;<br>			<span class="hljs-meta">@Override</span><br>			<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>				<span class="hljs-keyword">try</span> &#123;<br>          <span class="hljs-comment">//EurekaServerBootstrap is inited in EurekaServerAutoConfiguration</span><br>					eurekaServerBootstrap.contextInitialized(<br>							EurekaServerInitializerConfiguration.<span class="hljs-keyword">this</span>.servletContext);<br>					log.info(<span class="hljs-string">&quot;Started Eureka Server&quot;</span>);<br>          <span class="hljs-comment">//publish EurekaRegistryAvailableEvent</span><br>					publish(<span class="hljs-keyword">new</span> EurekaRegistryAvailableEvent(getEurekaServerConfig()));<br>					EurekaServerInitializerConfiguration.<span class="hljs-keyword">this</span>.running = <span class="hljs-keyword">true</span>;<br>          <span class="hljs-comment">//publish EurekaRegistryAvailableEvent</span><br>					publish(<span class="hljs-keyword">new</span> EurekaServerStartedEvent(getEurekaServerConfig()));<br>				&#125;<br>				<span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>					<span class="hljs-comment">// Help!</span><br>					log.error(<span class="hljs-string">&quot;Could not initialize Eureka servlet context&quot;</span>, ex);<br>				&#125;<br>			&#125;<br>		&#125;).start();<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>This also is a configuration class which implements <em>SmartLifecycle</em> interface, so this class will execute <em>start()</em> method if <em>isAutoStartup()</em> returns true after all beans are inited.</p>
<ul>
<li><p>Enter into <strong>EurekaServerBootstrap.contextInitialized(ServletContext context)</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextInitialized</span><span class="hljs-params">(ServletContext context)</span> </span>&#123;<br>		<span class="hljs-keyword">try</span> &#123;<br>			initEurekaEnvironment();<br>			initEurekaServerContext();<br><br>			context.setAttribute(EurekaServerContext.class.getName(), <span class="hljs-keyword">this</span>.serverContext);<br>		&#125;<br>		<span class="hljs-keyword">catch</span> (Throwable e) &#123;<br>			log.error(<span class="hljs-string">&quot;Cannot bootstrap eureka server :&quot;</span>, e);<br>			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;Cannot bootstrap eureka server :&quot;</span>, e);<br>		&#125;<br>	&#125;<br></code></pre></td></tr></table></figure></li>
<li><p>Enter into <strong>initEurekaServerContext()</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initEurekaServerContext</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br>        <span class="hljs-comment">//omit</span><br>        <span class="hljs-comment">//Copy registry from neighboring eureka node</span><br>        <span class="hljs-keyword">int</span> registryCount = <span class="hljs-keyword">this</span>.registry.syncUp();<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 1. Modify status to UP</span><br><span class="hljs-comment">         * 2. Use postInit in parent class to start a schedule method which is used for deleting server that does not renew in default(90s) period</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">this</span>.registry.openForTraffic(<span class="hljs-keyword">this</span>.applicationInfoManager, registryCount);<br>        <span class="hljs-comment">// Register all monitoring statistics.</span><br>        EurekaMonitors.registerAllStats();<br>    &#125;<br></code></pre></td></tr></table></figure>
<ol>
<li> <em>this.registry.syncUp()</em> by using the <em>PeerAwareInstanceRegistryImpl.syncUp()</em> method</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">syncUp</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-comment">// Copy entire entry from neighboring DS node</span><br>        <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br> <br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; ((i &lt; serverConfig.getRegistrySyncRetries()) &amp;&amp; (count == <span class="hljs-number">0</span>)); i++) &#123;<br>            <span class="hljs-keyword">if</span> (i &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    Thread.sleep(serverConfig.getRegistrySyncRetryWaitMs());<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    logger.warn(<span class="hljs-string">&quot;Interrupted during registry transfer..&quot;</span>);<br>                    <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>            Applications apps = eurekaClient.getApplications();<br>            <span class="hljs-keyword">for</span> (Application app : apps.getRegisteredApplications()) &#123;<br>                <span class="hljs-keyword">for</span> (InstanceInfo instance : app.getInstances()) &#123;<br>                    <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-keyword">if</span> (isRegisterable(instance)) &#123;<br>                            register(instance, instance.getLeaseInfo().getDurationInSecs(), <span class="hljs-keyword">true</span>);<br>                            count++;<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">catch</span> (Throwable t) &#123;<br>                        logger.error(<span class="hljs-string">&quot;During DS init copy&quot;</span>, t);<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>Get all server instances by http invocation, and then traverse all instances to register if the instance can be registered. The nature of register is add instance to the local property of AbstractInstanceRegistry:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; registry<br>            = <span class="hljs-keyword">new</span> ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;();<br></code></pre></td></tr></table></figure>
<ol start="2">
<li>Two steps in <em>PeerAwareInstanceRegistryImpl.openForTraffic()</em> method, first is setting status to UP and second is starting a schedule task to delete instance which does not renew in a default period.</li>
</ol>
<p>Enter into <em>AbstractInstanceRegistry.postInit()</em> method:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postInit</span><span class="hljs-params">()</span> </span>&#123;<br>        renewsLastMin.start();<br>        <span class="hljs-keyword">if</span> (evictionTaskRef.get() != <span class="hljs-keyword">null</span>) &#123;<br>            evictionTaskRef.get().cancel();<br>        &#125;<br>        evictionTaskRef.set(<span class="hljs-keyword">new</span> EvictionTask());<br>        evictionTimer.schedule(evictionTaskRef.get(),<br>                serverConfig.getEvictionIntervalTimerInMs(),<br>                serverConfig.getEvictionIntervalTimerInMs());<br>    &#125;<br></code></pre></td></tr></table></figure>
<p><em>new EvictionTask()</em> create a EvictionTask instance and invoke it’s run() method, this method will traverse all registered instances and find those who are expired and add them to expiredLeases, then update the status of instances in expiredLease to DELETED.</p>
</li>
</ul>
<p><strong>2.3 Core Bean</strong></p>
<p>① EurekaServerConfig：init eurekaServer configuration；</p>
<p>② EurekaController：init interfaces of dashboard and interfaces about information of eurekaServer；</p>
<p>③ PeerAwareInstanceRegistry：init registry of cluster；</p>
<p>④ PeerEurekaNodes：init cluster nodes；</p>
<p>⑤ EurekaServerContext：init instance and config context；</p>
<p>⑥ EurekaServerBootstrap：init start class of Eureka Server；</p>
<p>⑦ FilterRegistrationBean：register Jsrsey to Filter；</p>
<h4 id="3-Jersey-server-in-Eureka"><a href="#3-Jersey-server-in-Eureka" class="headerlink" title="3. Jersey server in Eureka"></a>3. Jersey server in Eureka</h4><p>3.1 Server Registry</p>
<p><em>ApplicationResource.addInstance()</em> method to invoke <em>PeerAwareInstanceRegistryImpl.register(final InstanceInfo info, final boolean isReplication)</em></p>
<p>3.2 Get All Instances Information</p>
<p><em>ApplicationsResource.getContainers()</em> get information from cache.</p>
<p>3.3 Get additional Instances Information</p>
<p><em>ApplicationsResource.getContainerDifferential()</em>, logic is the same as get all instances information.</p>
<p>3.4 HeartBeat</p>
<p>InstanceResource.renewLease(), the core logic is invoking <em>PeerAwareInstanceRegistryImpl.renew(final String appName, final String id, final boolean isReplication)</em> method to renew, and update it’s lastUpdateTimestamp.</p>
<p>3.5 Server Offline</p>
<p>InstanceResource.cancelLease(), the core logic is invoking <em>PeerAwareInstanceRegistryImpl.cancel(final String appName, final String id,final boolean isReplication)</em> to offline service and update status of instance to DELETE and update cache essentially.</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/toby-xu/p/13770595.html">Reference</a></p>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/blog/2021/02/01/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/">负载均衡算法</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2021-02-01T09:47:15.000Z" itemprop="datePublished">
    2021-02-01
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/blog/categories/Algorithm/">Algorithm</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <h3 id="负载均衡算法"><a href="#负载均衡算法" class="headerlink" title="负载均衡算法"></a>负载均衡算法</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>负载均衡的职责是将网络请求或者其他形式的负载均摊到不同的机器上，避免集群中部分服务器压力过大而另一些服务器空闲的情况。通过负载均衡，可以让每台服务器获取到适合自己处理能力的负载，为高负载服务器分流的同时，也可以避免资源浪费。以下将分析几种不同的负载均衡算法。</p>
        
          <div class="more-link">
            <a href="/blog/2021/02/01/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95/#more">Read On »</a>
          </div>
        
      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/blog/2021/01/30/QuickSort/">快速排序算法</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2021-01-30T12:39:46.000Z" itemprop="datePublished">
    2021-01-30
  </time>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/blog/categories/Algorithm/">Algorithm</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <a id="more"></a>

<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>快速排序算法是一种基于分治思想的排序算法，分治思想有以下特点：</p>
<ol>
<li>将一个问题可划分为同一类型的若干个子问题，子问题的规模相同或者相近</li>
<li>求解这些子问题，然后合并这些子问题的解，可得到原问题的答案</li>
</ol>
<p>​         快速排序的主要思想按照元素的值进行划分。对于一个数组A，经过一次快速排序后，使得A[i]左边的元素全都小于等于A[i]，A[i]右边的元素全部大于等于A[i]，然后利用相同的排序方式处理两个子数组（即A[i]左右两边的元素组成的数组），直到子数组的元素个数为1，此时原数组成为有序数组。</p>
<p>算法伪代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">QuickSort(A[low...high]):<br>	<span class="hljs-comment">//输入：数组A中起始下标为low，结束下标为high的所有元素</span><br>	<span class="hljs-comment">//输出：A[low...high]中的元素非降序排序</span><br>	<span class="hljs-keyword">if</span> low &lt; high:<br>			<span class="hljs-comment">//partition(A[low...high])函数返回s</span><br>			<span class="hljs-comment">//使s左边的元素全部小于等于A[s],s右边的元素全部大于等于A[s]</span><br>			s = partition(A[low...high])<br>      QuickSort(A[low...s-<span class="hljs-number">1</span>])<br>      QuickSort(A[s+<span class="hljs-number">1.</span>..high])<br></code></pre></td></tr></table></figure>


<h3 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">sort</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums)</span> </span>&#123;<br>  quickSort(nums, <span class="hljs-number">0</span>, nums.length - <span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">quickSort</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] nums, <span class="hljs-keyword">int</span> low. <span class="hljs-keyword">int</span> high)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span> (low &lt; high) &#123;<br>  	<span class="hljs-keyword">int</span> segment = partition(nums, low, high);<br>    quickSort(nums, low, segment - <span class="hljs-number">1</span>);<br>    quickSort(nums, segment + <span class="hljs-number">1</span>, high);<br>  &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> <span class="hljs-title">partition</span><span class="hljs-params">(<span class="hljs-keyword">int</span> nums, <span class="hljs-keyword">int</span> low, <span class="hljs-keyword">int</span> high)</span> </span>&#123;<br>  <span class="hljs-keyword">int</span> pivot = nums[low];<br>  <span class="hljs-keyword">while</span>(low &lt; high) &#123;<br>    <span class="hljs-keyword">while</span>(low &lt; high &amp;&amp; pivot &lt;= nums[high]) &#123;<br>      high--;<br>    &#125;<br>    nums[low] = nums[high];<br>    <span class="hljs-keyword">while</span>(low &lt; high &amp;&amp; pivot &gt;= nums[low]) &#123;<br>      low++;<br>    &#125;<br>    nums[high] = nums[low];<br>  &#125;<br>  nums[low] = pivot;<br>  <span class="hljs-keyword">return</span> low;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h3><ul>
<li><p>最优情况：分割点全都位于数组的中间位置，此时比较次数为:</p>
<p>C<sub>best</sub>(n) = 2C<sub>best</sub>(n/2) + n, C<sub>best</sub>(1) = 0</p>
</li>
<li><p>最坏情况：所有的分割点都在数组的端点位置，此时的比较次数为：</p>
<p>C<sub>worst</sub>(n) = (n + 1) + n + (n - 1) + … + 3, O(n<sup>2</sup>)</p>
</li>
<li><p>平均情况：</p>
<p>C<sub>avg</sub>(n) = 2nln(n) &#8776; 1.39nlog(2n)</p>
</li>
</ul>
<p>根据时间复杂度可以看出，该算法在平均情况下仅比最优情况下多执行39%的操作，其内循环的效率较高使得该算法在处理随机排列的数组时会比合并排序快。</p>
<h3 id="优化点"><a href="#优化点" class="headerlink" title="优化点"></a>优化点</h3><ul>
<li>更好的中轴选择方法：三平均划分法（以数据最左边，最右边和最中间元素的中位数作为分割点）</li>
<li>当子数组很小时，改用插入排序或不再进行排序，在算法结束后利用插入排序处理剩下未进行排序的元素，即利用两个算法进行排序。</li>
</ul>

      
    </div>
</article>

    </li>
  
    <li>
      <article class='ListView'>
    <header class="title">
      
        <h1>
          <a href="/blog/2021/01/29/%E8%82%A1%E7%A5%A8%E4%B9%B0%E5%8D%96%E7%9A%84%E6%9C%80%E4%BD%B3%E6%97%B6%E9%97%B4III/">股票的最佳买卖时间III</a>
        </h1>
      
      <div class='ListMeta'>
  <time datetime="2021-01-29T08:56:19.000Z" itemprop="datePublished">
    2021-01-29
  </time>
  
  | 
  <ul>
    
  <li class="meta-text">
  { <a href="/blog/tags/Algorithm/">Algorithm</a> }
  </li>


  </ul>
  
  
  / 
  <ul>
    
  <li class="meta-text">
  { <a href="/blog/categories/Algorithm/">Algorithm</a> }
  </li>

  <li class="meta-text">
  { <a href="/blog/categories/Algorithm/Leetcode/">Leetcode</a> }
  </li>


  </ul>
  
</div>

    </header>
    <div>
      
        <a id="more"></a>

<p><a target="_blank" rel="noopener" href="https://leetcode.com/problems/best-time-to-buy-and-sell-stock-iii/discuss/135704/Detail-explanation-of-DP-solution">原文链接</a></p>
<h3 id="题目描述："><a href="#题目描述：" class="headerlink" title="题目描述："></a>题目描述：</h3><p>给定一个数组， 它的第i个元素是一支给定的股票在第i天的价格。设计一个算法来计算你所能获取的最大利润，最多可完成两笔交易，且不能同时参与多笔交易，即再次购买之前必须出售掉之前的股票。</p>
<h3 id="问题分析："><a href="#问题分析：" class="headerlink" title="问题分析："></a>问题分析：</h3><p>得到该问题的动态转移方程并不难：<br>dp[k, i]=max⁡(dp[k, i −1], prices[i]−prices[j]+dp[k −1, j −1]), j=[0..i −1]</p>
<p>对于k笔交易，在第i天：<br>    • 如果我们选择不交易，那么收益跟前一天保持一致为dp[k, i-1]<br>    • 如果我们在j天买了股票(j=[0..i-1])，然后在第i天卖出了，那么我们的收益为 prices[i]−prices[j]+dp[k−1, j −1].</p>
<p>实际上j可以等于i，当j=i时，prices[i]−prices[j]+dp[k−1, j]= dp[k −1, i],看上去像是减少了一次交易机会。<br>我看到有些人在使用公式dp[k, i]=ma x⁡(dp[k, i −1], prices[i]−prices[j]+dp[k−i, j])，而不是dp[k −i, j −1].实际上这没有多大意义，如果股票在第j天被买入了，那么上一次交易的总收益应该与第j-1天的收益一样。当然，基于这种考虑的动态转移方程也是正确的，因为如果股票在第j天被出售了然后在当天又买回来了，这种情况与第j天没有进行交易是一样的。</p>
<p>所以，最直观的实现方式如下：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs glsl">public <span class="hljs-type">int</span> maxProfitDp(<span class="hljs-type">int</span>[] prices) &#123;<br>	<span class="hljs-keyword">if</span>(prices.<span class="hljs-built_in">length</span> == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span>[][] dp = new <span class="hljs-type">int</span>[<span class="hljs-number">3</span>][prices.<span class="hljs-built_in">length</span>];<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k = <span class="hljs-number">1</span>; k &lt;= <span class="hljs-number">2</span>; k++) &#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; prices.<span class="hljs-built_in">length</span>; i++) &#123;<br>			<span class="hljs-type">int</span> <span class="hljs-built_in">min</span> = prices[<span class="hljs-number">0</span>];<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j = <span class="hljs-number">1</span>; j &lt;= i; j++) &#123;<br>				<span class="hljs-built_in">min</span> = Math.<span class="hljs-built_in">min</span>(<span class="hljs-built_in">min</span>, prices[j] - dp[k - <span class="hljs-number">1</span>][j - <span class="hljs-number">1</span>]);<br>			&#125;<br>			dp[k][i] = Math.<span class="hljs-built_in">max</span>(dp[k][i - <span class="hljs-number">1</span>], prices[i] - <span class="hljs-built_in">min</span>);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> dp[<span class="hljs-number">2</span>][prices.<span class="hljs-built_in">length</span> - <span class="hljs-number">1</span>];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>时间复杂度为O(kn^2),空间复杂度为O(kn).</p>
<p>在上述代码中，min被重复计算了，我们可以进行优化：</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs glsl">public <span class="hljs-type">int</span> maxProfitDp(<span class="hljs-type">int</span>[] prices) &#123;<br>	<span class="hljs-keyword">if</span>(prices.<span class="hljs-built_in">length</span> == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-type">int</span>[][] dp = new <span class="hljs-type">int</span>[<span class="hljs-number">3</span>][prices.<span class="hljs-built_in">length</span>];<br>	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> k = <span class="hljs-number">1</span>; k &lt;= <span class="hljs-number">2</span>; k++) &#123;<br>		<span class="hljs-type">int</span> <span class="hljs-built_in">min</span> = prices[<span class="hljs-number">0</span>];<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt; prices.<span class="hljs-built_in">length</span>; i++) &#123;<br>			<span class="hljs-built_in">min</span> = Math.<span class="hljs-built_in">min</span>(<span class="hljs-built_in">min</span>, prices[i] - dp[k - <span class="hljs-number">1</span>][i - <span class="hljs-number">1</span>]);<br>			dp[k][i] = Math.<span class="hljs-built_in">max</span>(dp[k][i - <span class="hljs-number">1</span>], prices[i] - <span class="hljs-built_in">min</span>);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> dp[<span class="hljs-number">2</span>][prices.<span class="hljs-built_in">length</span> - <span class="hljs-number">1</span>];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>时间复杂度为O(kn),空间复杂度为O(kn).</p>
<p>如果我们将两个for循环进行交换：</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">maxProfitDp</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] prices)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span>(prices.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">int</span>[][] dp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">3</span>][prices.length];<br>	<span class="hljs-keyword">int</span>[] <span class="hljs-built_in">min</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">3</span>];<br>	Arrays.<span class="hljs-built_in">fill</span>(<span class="hljs-built_in">min</span>, prices[<span class="hljs-number">0</span>]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; prices.length; i++) &#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> k = <span class="hljs-number">1</span>; k &lt;= <span class="hljs-number">2</span>; k++) &#123;<br>			<span class="hljs-built_in">min</span>[k] = Math.<span class="hljs-built_in">min</span>(<span class="hljs-built_in">min</span>[k], prices[i] - dp[k - <span class="hljs-number">1</span>][i - <span class="hljs-number">1</span>]);<br>			dp[k][i] = Math.<span class="hljs-built_in">max</span>(dp[k, i - <span class="hljs-number">1</span>], prices[i] - <span class="hljs-built_in">min</span>[k]);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> dp[<span class="hljs-number">2</span>][prices.length - <span class="hljs-number">1</span>];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>我们需要在每次交易时都保存最小值min，所以会保存k个min。<br>我们发现二维数组的第二维i的值仅取决于前一个i-1的值，所以我们可以进行纬度压缩。(我们也可以压缩第一纬度k，因为第k个位置也是仅取决于第k-1个位置。但是两个维度不能同时压缩)</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">maxProfitDp</span><span class="hljs-params">(<span class="hljs-keyword">int</span>[] prices)</span> </span>&#123;<br>	<span class="hljs-keyword">if</span>(prices.length == <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">int</span>[] dp = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">3</span>];<br>	<span class="hljs-keyword">int</span>[] <span class="hljs-built_in">min</span> = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">3</span>];<br>	Arrays.<span class="hljs-built_in">fill</span>(<span class="hljs-built_in">min</span>, prices[<span class="hljs-number">0</span>]);<br>	<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; prices.length; i++) &#123;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">int</span> k = <span class="hljs-number">1</span>; k &lt;= <span class="hljs-number">2</span>; k++) &#123;<br>			<span class="hljs-built_in">min</span>[k] = Math.<span class="hljs-built_in">min</span>(<span class="hljs-built_in">min</span>[k], prices[i] - dp[k - <span class="hljs-number">1</span>]);<br>			dp[k] = Math.<span class="hljs-built_in">max</span>(dp[k], prices[i] - <span class="hljs-built_in">min</span>[k]);<br>		&#125;<br>	&#125;<br>	<span class="hljs-keyword">return</span> dp[<span class="hljs-number">2</span>];<br>&#125;<br></code></pre></td></tr></table></figure>
<p>此时时间复杂度为O(kn),空间复杂度为O(k).</p>
<p>在这道题中，k=2.我们可以将数组直接用变量代替</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public <span class="hljs-built_in">int</span> max<span class="hljs-constructor">ProfitDp(<span class="hljs-params">int</span>[] <span class="hljs-params">prices</span>)</span> &#123;<br>	<span class="hljs-built_in">int</span> buy1 = Integer.MAX_VALUE;<br>	<span class="hljs-built_in">int</span> buy2 = Integer.MAX_VALUE;<br>	<span class="hljs-built_in">int</span> sell1 = <span class="hljs-number">0</span>;<br>	<span class="hljs-built_in">int</span> sell2 = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; prices.length; i++) &#123;<br>		buy1 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Math</span>.</span></span>min(buy1, prices<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span>);<br>		sell1 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Math</span>.</span></span>max(sell1, prices<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span> - buy1);<br>		buy2 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Math</span>.</span></span>min(buy2, prices<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span> - sell1);<br>		sell2 = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Math</span>.</span></span>max(sell2, prices<span class="hljs-literal">[<span class="hljs-identifier">i</span>]</span> - buy2);<br>	&#125;<br>	return sell2;<br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>我们也可以用其他的方式来解释上面的代码。每一天我们都尽可能地买入最低价股票，并且尽可能地用最高价卖出。对于第二次交易，我们把第一次交易的盈利放入第二次交易的成本中(做差，第二次的成本减第一次的盈利prices[i]−sell1)，那么我们第二次交易的的盈利就是两次交易的盈利。</p>

      
    </div>
</article>

    </li>
  
</ul>

  <section id="nav-wrapper">
    <nav id="page-nav">
      <a class="extend prev" rel="prev" href="/blog/page/2/">« prev</a><a class="page-number" href="/blog/">1</a><a class="page-number" href="/blog/page/2/">2</a><span class="page-number current">3</span>
    </nav>
  </section>


            <footer>
    <div>© 2021 - Levi </div>
    <div>
        <span>
<!--            Powered by <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a>-->
            Homo sum, humani nihil a me alienum puto
        </span>
    </div>
<!--    {% if theme.footer.counter %}-->
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">Views <span id="busuanzi_value_site_pv"></span> </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_uv">Visitors <span id="busuanzi_value_site_uv"></span> </span>
<!--    {% endif %}-->
</footer>

        </div>
    </div>
</div>

<script src="/blog/js/pager/dist/singlepager.js"></script>

<script>
var sp = new Pager('data-pager-shell')

</script>
</body>
</html>